<!doctype html5>
<head>
<script src="https://vk.com/js/api/xd_connection.js?2" type="text/javascript"></script>
<script type="text/javascript"> 
  VK.init(function() { }); 
  //VK.callMethod("showSettingsBox");
  VK.callMethod("showGroupSettingsBox");
</script>
<script>
var imgcount=0;
var albumscount=0;
var vkuserid=0;
var albums=[];
var atoken;

function clear(text) {
   document.getElementById('status').innerHTML = '';
}
  
function append(text) {
   document.getElementById('status').innerHTML += text;
}
  
function autosize(width) {
        //Проверяем элемент body на наличие.
        if (!document.getElementById('body')) {
			alert('error');
            return;
        }
        // Успешно ли подключен ВК скрипт
        if (typeof VK.callMethod != 'undefined') {
        /*
        Вызываем функцию vk js api для управления окном.
        VK.callMethod('функция', параметры)
        В данном случае у нас - VK.callMethod('изменение_размеров_окна', ширина, высота);
        Так же добавляем еще 60 пикселей что бы было небольшое расстояние.
        */
            VK.callMethod('resizeWindow', 840, document.getElementById('body').clientHeight + 60);
        } else {
	    alert('error #2');
        }
    }
 
function getParameterByName(name, rfr) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    var results;
    if (rfr) {
      results = regex.exec(document.referrer);
    } else {
      results = regex.exec(window.location.search);
    }
    if (results == null)
      return null;
    else
      return decodeURIComponent(results[1].replace(/\+/g, " "));
}

function VKAPI_postcomments(oid,aid,itr,pdata,pitr,pid,npid, ocid, commenttext, cdata, citr)
{
	var comments=[];
	var mstr='От '+ ocid + ': '+commenttext;
	VK.api(
			'photos.createComment',
			{owner_id: vkuserid, photo_id: npid, message:mstr},
			function(data) {
				citr++;
				if(citr==cdata.response.length)
				{
					append('DONE');
					pitr++;
					setTimeout(VKAPI_photoscopy,350,owner_id,albums[itr],itr,pdata,pitr);
				}
				else
				{
					append('c'+citr);
					setTimeout(VKAPI_postcomments,350,oid,aid,itr,pdata,pitr,pid,npid,cdata.response[citr].from_id,cdata.response[citr].text,cdata,citr);
				}
			});
}

function VKAPI_getcomments(oid,aid,itr,pdata,pitr,pid,npid)
{
	var comments=[];
	var citr=0;
	VK.api(
			'photos.getcomments',
			{owner_id: oid, photo_id: pid},
			function(data) { 
			console.log(data);
			if (data.response) { 
				append('GetComments...');
				citr=0;
				setTimeout(VKAPI_postcomments,350,oid,aid,itr,pdata,pitr,pid,npid,data.response[citr].from_id, data.response[citr].text, data, citr);
			} else {
				clear();
				append('Error: <pre>' + JSON.stringify(data.error, null, '  ') + '</pre>');
			}
			});
}

function VKAPI_photoscopy(oid,aid,itr,pdata,pitr)
{
	if(pitr==pdata.response.length)
	{
		itr++;
		setTimeout(VKAPI_photosget,350,owner_id,albums[itr],itr);
		
	}
	else
	{
	photoid=pdata.response[pitr].pid
	VK.api(
			'photos.copy',
			{owner_id: oid, photo_id: photoid},
			function(data) { 
			console.log(data);
			if (data.response) { 
				append('Copied...');
				setTimeout(VKAPI_getcomments,350,oid,aid,itr,pdata,pitr,photoid,data.response);
			} else {
				clear();
				append('Error: <pre>' + JSON.stringify(data.error, null, '  ') + '</pre>');
			}
			});
	}
}


function VKAPI_photosget(oid,aid,itr)
{
	VK.api(
			'photos.get',
			{owner_id: oid, album_id: aid},
			function(data) { 
			console.log(data);
			if (data.response) { 
				var pitr=0;
				for (var j in data.response) {
				//append(data.response[j].pid + ' ');
				imgcount++;
				}
				append(Number(100*itr/albumscount).toFixed(2) + '% P[' + j + '] ');
			
				if(itr==albumscount){
					append('TOTAL[' + imgcount + '] ');
					}
				else if(aid==238406974){
					append('Copying...');
					var pdata=data;
					pitr=0;
					setTimeout(VKAPI_photoscopy,350,oid,albums[itr],itr,pdata,pitr);
					//itr++;
					//setTimeout(VKAPI_photosget,700,owner_id,albums[itr],itr);
				}
				else
				{
					itr++;
					setTimeout(VKAPI_photosget,350,oid,albums[itr],itr);
				}
			} else {
				clear();
				append('Error: <pre>' + JSON.stringify(data.error, null, '  ') + '</pre>');
			}
			});
}

  
function loadAlbums(owner_id) {
  albums=[];
  imgcount=0;
  clear();
  //VK.callMethod("showGroupSettingsBox");
  vkuserid=getParameterByName("viewer_id");
  atoken=getParameterByName("access_token");
  VK.api(
    'photos.getAlbums',
    {owner_id: owner_id},
    function(data) { 
      console.log(data);
      if (data.response) { 
	// albumscount=data.length;
         for (var i in data.response) {
           	   //append(data.response[i].aid + ' ');
		   albums[i]=data.response[i].aid;
		   //sleep(3000);
		   
         }
		 setTimeout(VKAPI_photosget,350,owner_id,albums[0],0);
	 append('A[' + i + ']');
	  albumscount=i;
	 //append('TOTAL:' + imgcount);
      } else {
         clear();
         append('Error: <pre>' + JSON.stringify(data.error, null, '  ') + '</pre>');
      }
  });
/*  for (var i in albums) {
	VK.api(
		'photos.get',
		{owner_id: owner_id, album_id: albums[i]},
		function(data) { 
		console.log(data);
		if (data.response) { 
			for (var j in data.response) {
			append(data.response[j].id + ' ');
			imgcount++;
			}
		append('TOTAL:' + j);
		} else {
			clear();
			append('Error: <pre>' + JSON.stringify(data.error, null, '  ') + '</pre>');
		}
	});
  }*/
  
  VK.callMethod("resizeWindow", 800, 4000); 
}

</script>
</head>
<body>

ID сообщества:
<input type="text" id="owner_id">
<button onclick="loadAlbums(document.getElementById('owner_id').value)">Load Albums</button>

<div id="status"></div>

</body>
